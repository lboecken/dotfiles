#! /bin/zsh

CURRENT_BRANCH="$(git branch --show-current)"
TARGET_BRANCH="${1:-master}"

if [ -n "$(git status --porcelain --untracked-files=no)" ]; then
	echo "uncommitted changes on branch"
	exit 1 
fi
echo "ready to rebase"

git switch $TARGET_BRANCH &> /dev/null
if [ $? -ne 0 ];then
	echo "git switch to $TARGET_BRANCH failed"
	exit 1
fi
echo "switched to $TARGET_BRANCH"

git pull &> /dev/null
if [ $? -ne 0 ]; then
	echo "git pull on $TARGET_BRANCH failed"
	git switch $CURRENT_BRANCH 
	exit 1
fi
echo "updated $BRANCH from remote"

git switch $TARGET_BRANCH &> /dev/null
if [ $? -ne 0 ]; then
	echo "git switch back to original failed"
	exit 1
fi
echo "switched back to starting branch"

git rebase $BRANCH && git push --force-with-lease &> /dev/null

echo "finished rebase & pushed to remote"
